import type { NearbyEntry } from "@/lib/types/rpe";

/**
 * Standard Mike Tuchscherer RPE chart (extended).
 * RPE_CHART[reps][rpe] = decimal percentage of 1RM.
 */
const RPE_CHART: Record<number, Record<number, number>> = {
  1: { 5: 0.85, 5.5: 0.865, 6: 0.88, 6.5: 0.895, 7: 0.91, 7.5: 0.925, 8: 0.94, 8.5: 0.955, 9: 0.97, 9.5: 0.985, 10: 1.0 },
  2: { 5: 0.825, 5.5: 0.84, 6: 0.855, 6.5: 0.87, 7: 0.885, 7.5: 0.9, 8: 0.915, 8.5: 0.93, 9: 0.945, 9.5: 0.96, 10: 0.975 },
  3: { 5: 0.8, 5.5: 0.815, 6: 0.83, 6.5: 0.845, 7: 0.86, 7.5: 0.875, 8: 0.89, 8.5: 0.905, 9: 0.92, 9.5: 0.935, 10: 0.955 },
  4: { 5: 0.784, 5.5: 0.796, 6: 0.808, 6.5: 0.82, 7: 0.835, 7.5: 0.85, 8: 0.865, 8.5: 0.88, 9: 0.895, 9.5: 0.91, 10: 0.93 },
  5: { 5: 0.762, 5.5: 0.774, 6: 0.786, 6.5: 0.799, 7: 0.811, 7.5: 0.824, 8: 0.84, 8.5: 0.855, 9: 0.87, 9.5: 0.885, 10: 0.905 },
  6: { 5: 0.739, 5.5: 0.751, 6: 0.764, 6.5: 0.777, 7: 0.789, 7.5: 0.802, 8: 0.815, 8.5: 0.83, 9: 0.845, 9.5: 0.86, 10: 0.88 },
  7: { 5: 0.717, 5.5: 0.73, 6: 0.743, 6.5: 0.756, 7: 0.768, 7.5: 0.781, 8: 0.793, 8.5: 0.806, 9: 0.82, 9.5: 0.835, 10: 0.855 },
  8: { 5: 0.699, 5.5: 0.711, 6: 0.723, 6.5: 0.735, 7: 0.748, 7.5: 0.76, 8: 0.773, 8.5: 0.786, 9: 0.799, 9.5: 0.812, 10: 0.83 },
  9: { 5: 0.677, 5.5: 0.69, 6: 0.703, 6.5: 0.716, 7: 0.728, 7.5: 0.74, 8: 0.753, 8.5: 0.766, 9: 0.779, 9.5: 0.792, 10: 0.81 },
  10: { 5: 0.67, 5.5: 0.679, 6: 0.688, 6.5: 0.697, 7: 0.71, 7.5: 0.723, 8: 0.735, 8.5: 0.748, 9: 0.76, 9.5: 0.773, 10: 0.79 },
  11: { 5: 0.655, 5.5: 0.664, 6: 0.673, 6.5: 0.682, 7: 0.694, 7.5: 0.706, 8: 0.718, 8.5: 0.73, 9: 0.742, 9.5: 0.755, 10: 0.773 },
  12: { 5: 0.64, 5.5: 0.649, 6: 0.658, 6.5: 0.667, 7: 0.679, 7.5: 0.69, 8: 0.703, 8.5: 0.713, 9: 0.725, 9.5: 0.738, 10: 0.755 },

  // Extended range (extrapolated)
  13: { 5: 0.625, 5.5: 0.634, 6: 0.643, 6.5: 0.652, 7: 0.664, 7.5: 0.675, 8: 0.688, 8.5: 0.698, 9: 0.71, 9.5: 0.723, 10: 0.74 },
  14: { 5: 0.61, 5.5: 0.619, 6: 0.628, 6.5: 0.637, 7: 0.649, 7.5: 0.66, 8: 0.673, 8.5: 0.683, 9: 0.695, 9.5: 0.708, 10: 0.725 },
  15: { 5: 0.595, 5.5: 0.604, 6: 0.613, 6.5: 0.622, 7: 0.634, 7.5: 0.645, 8: 0.658, 8.5: 0.668, 9: 0.68, 9.5: 0.693, 10: 0.71 },
  16: { 5: 0.58, 5.5: 0.589, 6: 0.598, 6.5: 0.607, 7: 0.619, 7.5: 0.63, 8: 0.643, 8.5: 0.653, 9: 0.665, 9.5: 0.678, 10: 0.695 },
  17: { 5: 0.565, 5.5: 0.574, 6: 0.583, 6.5: 0.592, 7: 0.604, 7.5: 0.615, 8: 0.628, 8.5: 0.638, 9: 0.65, 9.5: 0.663, 10: 0.68 },
  18: { 5: 0.55, 5.5: 0.559, 6: 0.568, 6.5: 0.577, 7: 0.589, 7.5: 0.6, 8: 0.613, 8.5: 0.623, 9: 0.635, 9.5: 0.648, 10: 0.665 },
  19: { 5: 0.535, 5.5: 0.544, 6: 0.553, 6.5: 0.562, 7: 0.574, 7.5: 0.585, 8: 0.598, 8.5: 0.608, 9: 0.62, 9.5: 0.633, 10: 0.65 },
  20: { 5: 0.52, 5.5: 0.529, 6: 0.538, 6.5: 0.547, 7: 0.559, 7.5: 0.57, 8: 0.583, 8.5: 0.593, 9: 0.605, 9.5: 0.618, 10: 0.635 },
};

export const RPE_VALUES = [5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5, 10];

export const REP_VALUES = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];

export function getRpePercentage(reps: number, rpe: number): number | null {
  const repRow = RPE_CHART[reps];
  if (!repRow) return null;
  const pct = repRow[rpe];
  return pct ?? null;
}

export function roundToIncrement(weight: number, increment: number): number {
  return Math.round(weight / increment) * increment;
}

export function getNearbyEntries(reps: number, rpe: number, oneRepMax: number, increment: number): NearbyEntry[] {
  const entries: NearbyEntry[] = [];

  for (const r of RPE_VALUES) {
    if (Math.abs(r - rpe) > 1.0) continue;
    const pct = getRpePercentage(reps, r);
    if (pct === null) continue;
    entries.push({
      rpe: r,
      percentage: pct,
      weight: roundToIncrement(oneRepMax * pct, increment),
    });
  }

  return entries;
}
